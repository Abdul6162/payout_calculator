<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Partner Payout Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- 
    Application Structure Plan: The application is designed as a task-oriented dashboard. The primary user task is to calculate potential earnings. The layout is a two-part grid: Inputs on the left, and Outputs on the right. This allows users to immediately see the result of their changes. Below this main tool, a What-If analysis provides deeper strategic insights via data tables.
    -->
    <style>
        :root {
            --onic-purple: #5F259F;
            --onic-dark: #1E1E1E;
            --onic-accent-pink: #E5007E;
            --onic-light-gray: #f8f9fa;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--onic-light-gray); }
        .input-group { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .input-sync-group { position: relative; display: flex; align-items: center; gap: 1rem; }
        .input-sync-group input[type=range] { flex-grow: 1; }
        .input-sync-group input[type=number] { width: 5rem; text-align: right; }
        .slider-tooltip {
            position: absolute;
            top: -2.5rem;
            transform: translateX(-50%);
            background-color: var(--onic-purple);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            display: none;
            white-space: nowrap;
        }
        .input-with-percent { position: relative; }
        .input-with-percent span { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .input-with-percent input { padding-right: 2.25rem; }
        .content-locked {
            opacity: 0.4;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
            filter: blur(2px);
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold" style="color: var(--onic-dark);">Partner Payout Calculator</h1>
            <p class="mt-2 text-lg text-slate-600">Estimate your earnings based on your performance.</p>
        </header>

        <!-- Province Selection Gate -->
        <div id="province-gate" class="input-group mb-8 text-center">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Select Your Province to Begin</h2>
            <p class="text-slate-600 mb-4">Province selection is required for accurate tax calculations.</p>
            <div class="max-w-md mx-auto">
                <select id="province" class="block w-full rounded-md border-slate-300 shadow-sm p-3 text-lg">
                    <option value="" disabled selected>-- Select Province --</option>
                    <option value="punjab">Punjab</option>
                    <option value="kpk">KPK</option>
                    <option value="sindh">Sindh</option>
                    <option value="balochistan">Balochistan</option>
                </select>
            </div>
        </div>

        <div id="main-content" class="content-locked">
            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                
                <!-- Left Column: Inputs -->
                <div class="lg:col-span-3 space-y-6">
                    <!-- Targets Input Group -->
                    <div class="input-group">
                        <h2 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2">Your Targets</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <label for="target-main" class="block text-sm font-medium text-slate-700">Overall Activation Target</label>
                                <input type="number" id="target-main" placeholder="e.g., 200" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                            </div>
                            <div></div>
                            <div class="input-with-percent">
                                <label for="target-mnp-a-perc" class="block text-sm font-medium text-slate-700">MNP Target (A)</label>
                                <input type="number" id="target-mnp-a-perc" placeholder="10" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                                <span>%</span>
                            </div>
                            <div class="bg-slate-50 p-2 rounded-lg text-center">
                                <p class="text-sm text-slate-500">Abs. Target (A)</p>
                                <p id="abs-target-mnp-a" class="font-bold text-slate-800">0</p>
                            </div>
                            <div class="input-with-percent">
                                <label for="target-mnp-b-perc" class="block text-sm font-medium text-slate-700">MNP Target (B)</label>
                                <input type="number" id="target-mnp-b-perc" placeholder="15" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                                 <span>%</span>
                            </div>
                             <div class="bg-slate-50 p-2 rounded-lg text-center">
                                <p class="text-sm text-slate-500">Abs. Target (B)</p>
                                <p id="abs-target-mnp-b" class="font-bold text-slate-800">0</p>
                            </div>
                            <div class="input-with-percent">
                                <label for="target-mnp-c-perc" class="block text-sm font-medium text-slate-700">MNP Target (C)</label>
                                <input type="number" id="target-mnp-c-perc" placeholder="20" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                                 <span>%</span>
                            </div>
                             <div class="bg-slate-50 p-2 rounded-lg text-center">
                                <p class="text-sm text-slate-500">Abs. Target (C)</p>
                                <p id="abs-target-mnp-c" class="font-bold text-slate-800">0</p>
                            </div>
                        </div>
                        <!-- MNP Validation Message Area -->
                        <div id="mnp-target-error" class="hidden text-red-600 text-sm mt-4 p-3 bg-red-50 rounded-lg"></div>
                    </div>

                    <!-- Achievements Input Group -->
                    <div class="input-group">
                        <h2 class="text-xl font-bold text-slate-700 mb-1 border-b pb-2">Your Achievements</h2>
                        <p class="text-xs text-slate-500 mb-4 italic">Default values are set for a high-performance scenario. Please adjust the sliders to match your projections.</p>
                        <div class="space-y-6">
                            <div>
                                <label for="achieved-tva-perc" class="block text-sm font-medium text-slate-700 mb-1">TVA Achievement %</label>
                                <div class="input-sync-group">
                                    <div class="slider-tooltip"></div>
                                    <input type="range" id="achieved-tva-perc" min="0" max="200" value="115" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                    <input type="number" id="achieved-tva-perc-num" min="0" max="200" value="115" class="p-2 rounded-md border-slate-300 shadow-sm">
                                </div>
                            </div>
                            <div>
                                <label for="achieved-qos-overall" class="block text-sm font-medium text-slate-700 mb-1">Overall QoS %</label>
                                <div class="input-sync-group">
                                     <div class="slider-tooltip"></div>
                                    <input type="range" id="achieved-qos-overall" min="0" max="100" value="55" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                    <input type="number" id="achieved-qos-overall-num" min="0" max="100" value="55" class="p-2 rounded-md border-slate-300 shadow-sm">
                                </div>
                            </div>
                            <div>
                                 <label for="achieved-qos-specific" class="block text-sm font-medium text-slate-700 mb-1">QoS % (w/o other plans)</label>
                                <div class="input-sync-group">
                                     <div class="slider-tooltip"></div>
                                    <input type="range" id="achieved-qos-specific" min="0" max="100" value="45" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                    <input type="number" id="achieved-qos-specific-num" min="0" max="100" value="45" class="p-2 rounded-md border-slate-300 shadow-sm">
                                </div>
                            </div>
                            <div class="pt-4 border-t">
                                 <label for="achieved-mnp-abs" class="block text-sm font-medium text-slate-700">MNP Achieved (without Ufone)</label>
                                 <p class="text-xs text-slate-500 mb-1">Enter your projected MNP numbers. This is optional.</p>
                                 <input type="number" id="achieved-mnp-abs" placeholder="e.g. 50" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                                 <div id="mnp-status-feedback" class="mt-2 text-sm text-center p-3 rounded-lg" style="background-color: #f3e9fd;"></div>
                            </div>
                            
                            <div class="mt-6 pt-4 border-t">
                                <h3 class="text-md font-semibold text-slate-600 mb-2">Calculated Absolute Achievements</h3>
                                <div class="grid grid-cols-2 gap-2 text-sm">
                                    <div class="bg-slate-50 p-2 rounded-lg">
                                        <p class="text-slate-500">Total Activations</p>
                                        <p id="abs-total-activations" class="font-bold text-slate-800">0</p>
                                    </div>
                                    <div class="bg-slate-50 p-2 rounded-lg">
                                        <p class="text-slate-500">MNP Achieved</p>
                                        <p id="abs-mnp-ach" class="font-bold text-slate-800">0</p>
                                    </div>
                                    <div class="bg-slate-50 p-2 rounded-lg">
                                        <p class="text-slate-500">QoS Overall (Abs)</p>
                                        <p id="abs-qos-overall" class="font-bold text-slate-800">0</p>
                                    </div>
                                    <div class="bg-slate-50 p-2 rounded-lg">
                                        <p class="text-slate-500">QoS Specific (Abs)</p>
                                        <p id="abs-qos-specific" class="font-bold text-slate-800">0</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                     <!-- Shoutout Display -->
                    <div id="shoutout-section" class="input-group text-center" style="background-color: var(--onic-purple); color: white;">
                    </div>
                </div>

                <!-- Right Column: Outputs -->
                <div class="lg:col-span-2">
                    <div id="output-container" class="text-white rounded-xl shadow-lg p-6 sticky top-8" style="background-color: var(--onic-dark);">
                        <h2 class="text-xl font-bold mb-4 border-b border-slate-600 pb-2">Payout & Tax Breakdown</h2>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">MTS-S Rent</span>
                                <span id="output-mts-rent" class="font-semibold">PKR 0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">Per SIM Payout</span>
                                <span id="output-per-sim" class="font-semibold">PKR 0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">TVA Payout (<span id="output-tva-perc" class="text-xs">0%</span>)</span>
                                <span id="output-tva" class="font-semibold">PKR 0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300">QoS Payout</span>
                                <span id="output-qos" class="font-semibold">PKR 0</span>
                            </div>
                            <div class="flex justify-between items-center pb-2">
                                <span class="text-slate-300">MNP Payout (Top Slab)</span>
                                <span id="output-mnp" class="font-semibold">PKR 0</span>
                            </div>
                            <p id="mnp-condition-msg" class="text-xs text-amber-400 text-center hidden">MNP payout requires 100% of overall target.</p>
                            
                            <div class="border-t border-slate-600 !mt-3 pt-3 space-y-2">
                                 <div class="flex justify-between items-center font-bold text-base">
                                     <span class="text-slate-200">Net Payout</span>
                                     <span id="output-net-payout" class="text-slate-100">PKR 0</span>
                                 </div>
                                <div class="flex justify-between items-center">
                                     <span id="label-gst" class="text-slate-300">GST</span>
                                     <span id="output-gst" class="font-semibold">PKR 0</span>
                                 </div>
                                 <div class="flex justify-between items-center font-bold text-base pb-2">
                                     <span class="text-slate-200">Total Payout</span>
                                     <span id="output-total-payout" class="text-slate-100">PKR 0</span>
                                 </div>
                            </div>

                             <div class="border-t border-slate-600 !mt-3 pt-3 space-y-2">
                                 <div class="flex justify-between items-center">
                                     <span class="text-slate-300">Income Tax Withheld (12%)</span>
                                     <span id="output-income-tax" class="font-semibold text-red-400">(PKR 0)</span>
                                 </div>
                                 <div class="flex justify-between items-center">
                                     <span id="label-gst-withheld" class="text-slate-300">GST Withheld</span>
                                     <span id="output-gst-withheld" class="font-semibold text-red-400">(PKR 0)</span>
                                 </div>
                                 <div class="flex justify-between items-center mt-1 p-2 rounded-md bg-sky-900">
                                     <span id="label-gst-payable" class="text-sky-300">Your GST Liability (Payable to RTA)</span>
                                     <span id="output-gst-payable" class="font-semibold text-sky-300">PKR 0</span>
                                 </div>
                            </div>
                            
                            <div class="border-t border-slate-600 !mt-3 pt-3 space-y-3">
                                <div class="flex justify-between items-center text-xl">
                                    <span class="font-bold">Amount Credited</span>
                                    <span id="output-final-credited" class="font-extrabold" style="color: var(--onic-accent-pink);">PKR 0</span>
                                </div>
                                 <div class="flex justify-between items-center text-base">
                                     <span class="text-slate-300">Pure Partner Earning</span>
                                     <span id="output-pure-earning" class="font-semibold text-sky-400">PKR 0</span>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- What If Analysis -->
            <section class="mt-12">
                <h2 class="text-2xl font-bold text-center mb-1" style="color: var(--onic-dark);">What-If Analysis: Earning Potential</h2>
                <p class="text-slate-500 text-center mb-8">See how "Pure Partner Earning" changes with TVA and QoS achievements for each MNP slab.</p>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="input-group">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4 text-center">Analysis for MNP Slab A</h3>
                        <div id="whatif-table-a" class="mt-4"></div>
                    </div>
                    <div class="input-group">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4 text-center">Analysis for MNP Slab B</h3>
                        <div id="whatif-table-b" class="mt-4"></div>
                    </div>
                    <div class="input-group">
                        <h3 class="text-lg font-semibold text-slate-700 mb-4 text-center">Analysis for MNP Slab C</h3>
                        <div id="whatif-table-c" class="mt-4"></div>
                    </div>
                </div>
            </section>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURATION & CONSTANTS ---
        const tvaTiers = [
            { threshold: 115, value: 400, label: '115%+' }, { threshold: 110, value: 300, label: '110-115%' },
            { threshold: 100, value: 200, label: '100-110%' }, { threshold: 90, value: 0, label: '90-100%' },
            { threshold: 75, value: -100, label: '75-90%' }, { threshold: 50, value: -200, label: '50-75%' },
            { threshold: 0, value: -300, label: '< 50%' }
        ];
        const qosTiers = [
            { threshold: 55, value: 600, label: '55%+' }, { threshold: 45, value: 400, label: '45-55%' },
            { threshold: 40, value: 200, label: '40-45%' }, { threshold: 30, value: -200, label: '30-40%' },
            { threshold: 0, value: -300, label: '< 30%' }
        ];

        // --- DOM ELEMENT REFERENCES ---
        const provinceGate = document.getElementById('province-gate');
        const mainContent = document.getElementById('main-content');
        
        const inputs = {
            province: document.getElementById('province'),
            targetMain: document.getElementById('target-main'),
            targetMnpAPerc: document.getElementById('target-mnp-a-perc'),
            targetMnpBPerc: document.getElementById('target-mnp-b-perc'),
            targetMnpCPerc: document.getElementById('target-mnp-c-perc'),
            achievedTvaPerc: document.getElementById('achieved-tva-perc'),
            achievedTvaPercNum: document.getElementById('achieved-tva-perc-num'),
            achievedQosOverall: document.getElementById('achieved-qos-overall'),
            achievedQosOverallNum: document.getElementById('achieved-qos-overall-num'),
            achievedQosSpecific: document.getElementById('achieved-qos-specific'),
            achievedQosSpecificNum: document.getElementById('achieved-qos-specific-num'),
            achievedMnpAbs: document.getElementById('achieved-mnp-abs'),
        };

        const outputs = {
            outputContainer: document.getElementById('output-container'),
            mtsRent: document.getElementById('output-mts-rent'),
            perSim: document.getElementById('output-per-sim'),
            tva: document.getElementById('output-tva'),
            tvaPerc: document.getElementById('output-tva-perc'),
            qos: document.getElementById('output-qos'),
            mnp: document.getElementById('output-mnp'),
            netPayout: document.getElementById('output-net-payout'),
            gst: document.getElementById('output-gst'),
            totalPayout: document.getElementById('output-total-payout'),
            incomeTax: document.getElementById('output-income-tax'),
            gstWithheld: document.getElementById('output-gst-withheld'),
            gstPayable: document.getElementById('output-gst-payable'),
            finalCredited: document.getElementById('output-final-credited'),
            pureEarning: document.getElementById('output-pure-earning'),
            mnpMsg: document.getElementById('mnp-condition-msg'),
            mnpStatusFeedback: document.getElementById('mnp-status-feedback'),
            absTargetMnpA: document.getElementById('abs-target-mnp-a'),
            absTargetMnpB: document.getElementById('abs-target-mnp-b'),
            absTargetMnpC: document.getElementById('abs-target-mnp-c'),
            labelGst: document.getElementById('label-gst'),
            labelGstWithheld: document.getElementById('label-gst-withheld'),
            labelGstPayable: document.getElementById('label-gst-payable'),
            shoutoutSection: document.getElementById('shoutout-section'),
            mnpTargetError: document.getElementById('mnp-target-error'),
        };
        
        const absOutputs = {
            totalActivations: document.getElementById('abs-total-activations'),
            qosOverall: document.getElementById('abs-qos-overall'),
            qosSpecific: document.getElementById('abs-qos-specific'),
            mnpAch: document.getElementById('abs-mnp-ach'),
        };

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value) => `PKR ${Math.round(value).toLocaleString()}`;
        const formatNegativeCurrency = (value) => `(PKR ${Math.round(Math.abs(value)).toLocaleString()})`;

        // --- VALIDATION LOGIC ---
        function validateMnpTargets() {
            const valA = parseInt(inputs.targetMnpAPerc.value) || 0;
            const valB = parseInt(inputs.targetMnpBPerc.value) || 0;
            const valC = parseInt(inputs.targetMnpCPerc.value) || 0;

            if (valB > 0 && valB < valA) {
                outputs.mnpTargetError.textContent = 'Caution: Slab B target must be greater than or equal to Slab A.';
                outputs.mnpTargetError.classList.remove('hidden');
                return false;
            }
            if (valC > 0 && valC < valB) {
                outputs.mnpTargetError.textContent = 'Caution: Slab C target must be greater than or equal to Slab B.';
                outputs.mnpTargetError.classList.remove('hidden');
                return false;
            }
            if ((valA > 0 && valA < 10) || valC > 35) {
                 outputs.mnpTargetError.textContent = 'Caution: Please re-check your MNP Slabs. It seems you have inserted a value outside the valid range.';
                 outputs.mnpTargetError.classList.remove('hidden');
                 return false;
            }

            outputs.mnpTargetError.classList.add('hidden');
            return true;
        }

        // --- CORE CALCULATION LOGIC ---
        function calculatePayout() {
            // 1. Validate inputs first
            if (!validateMnpTargets() || !inputs.province.value) {
                outputs.outputContainer.classList.add('disabled');
                return; // Stop calculation if validation fails or province not selected
            }
            outputs.outputContainer.classList.remove('disabled');

            // 2. Get all input values
            const targetMain = parseInt(inputs.targetMain.value) || 0;
            const targetMnpAPerc = parseInt(inputs.targetMnpAPerc.value) || 0;
            const targetMnpBPerc = parseInt(inputs.targetMnpBPerc.value) || 0;
            const targetMnpCPerc = parseInt(inputs.targetMnpCPerc.value) || 0;
            const province = inputs.province.value;
            const tvaPercentage = parseInt(inputs.achievedTvaPerc.value) || 0;
            const qosOverallPerc = parseInt(inputs.achievedQosOverall.value) || 0;
            const qosSpecificPerc = parseInt(inputs.achievedQosSpecific.value) || 0;
            const achievedMnpAbs = parseInt(inputs.achievedMnpAbs.value) || 0;
            
            // 3. Calculate base values
            const achievedTva = Math.round((tvaPercentage / 100) * targetMain);
            let mtsRentPayout = achievedTva * 450;
            let perSimPayout = achievedTva * 700;
            
            // 4. Calculate TVA Payout/Deduction
            let tvaPayout = 0;
            const currentTvaTier = tvaTiers.find(t => tvaPercentage >= t.threshold);
            if (currentTvaTier) {
                if (currentTvaTier.value >= 0) { tvaPayout = currentTvaTier.value * achievedTva; } 
                else { const deficit = targetMain - achievedTva; tvaPayout = deficit > 0 ? deficit * currentTvaTier.value : 0; }
            }
            
            // 5. Calculate QoS Payout/Deduction
            let qosPayout = 0;
            const currentQosTier = qosTiers.find(t => qosOverallPerc >= t.threshold);
            if(currentQosTier) {
                if (currentQosTier.value >= 0) { qosPayout = (qosSpecificPerc / 100) * currentQosTier.value * achievedTva; } 
                else { const qualityDeficit = targetMain - ((qosOverallPerc / 100) * achievedTva); qosPayout = qualityDeficit > 0 ? currentQosTier.value * qualityDeficit : 0; }
            }
            
            // 6. Calculate MNP Payout
            const targetMnpANum = Math.round((targetMnpAPerc / 100) * targetMain);
            const targetMnpBNum = Math.round((targetMnpBPerc / 100) * targetMain);
            const targetMnpCNum = Math.round((targetMnpCPerc / 100) * targetMain);
            
            let mnpPayout = 0;
            let currentMnpSlab = 'None';
            if (tvaPercentage >= 100) {
                if (achievedMnpAbs >= targetMnpCNum && targetMnpCNum > 0) { mnpPayout = achievedMnpAbs * 700; currentMnpSlab = 'C'; } 
                else if (achievedMnpAbs >= targetMnpBNum && targetMnpBNum > 0) { mnpPayout = achievedMnpAbs * 500; currentMnpSlab = 'B'; } 
                else if (achievedMnpAbs >= targetMnpANum && targetMnpANum > 0) { mnpPayout = achievedMnpAbs * 300; currentMnpSlab = 'A'; }
            } 
            
            // 7. Calculate Net and Tax values
            const netPayout = mtsRentPayout + perSimPayout + tvaPayout + qosPayout + mnpPayout;
            let gstRate = 0, gstWithheldRate = 0;
            if (province === 'punjab') { gstRate = 0.16; gstWithheldRate = 1.0; } 
            else if (province === 'kpk') { gstRate = 0.15; gstWithheldRate = 0.50; } 
            else if (province === 'sindh' || province === 'balochistan') { gstRate = 0.15; gstWithheldRate = 0.20; }

            const gstAmount = netPayout * gstRate;
            const totalPayout = netPayout + gstAmount;
            const incomeTaxWithheld = totalPayout * 0.12;
            const gstWithheld = gstAmount * gstWithheldRate;
            const gstPayable = gstAmount * (1 - gstWithheldRate);
            const pureEarning = netPayout - incomeTaxWithheld;
            const finalCredited = totalPayout - incomeTaxWithheld - gstWithheld;

            // 8. Update UI & Charts
            updateUI(achievedTva, tvaPercentage, qosOverallPerc, qosSpecificPerc, achievedMnpAbs, currentMnpSlab, {A: targetMnpANum, B: targetMnpBNum, C: targetMnpCNum}, {
                mtsRentPayout, perSimPayout, tvaPayout, qosPayout, mnpPayout, netPayout, gstRate, gstAmount, totalPayout, incomeTaxWithheld, gstWithheldRate, gstWithheld, gstPayable, finalCredited, pureEarning
            });
            updateShoutout(pureEarning, achievedTva, achievedMnpAbs, qosOverallPerc);
        }

        // --- UI UPDATE FUNCTIONS ---
        function updateUI(achievedTva, tvaPercentage, qosOverallPerc, qosSpecificPerc, achievedMnpAbs, currentMnpSlab, mnpTargets, payouts) {
            outputs.mtsRent.textContent = formatCurrency(payouts.mtsRentPayout);
            outputs.perSim.textContent = formatCurrency(payouts.perSimPayout);
            outputs.tva.textContent = formatCurrency(payouts.tvaPayout);
            outputs.qos.textContent = formatCurrency(payouts.qosPayout);
            outputs.mnp.textContent = formatCurrency(payouts.mnpPayout);
            outputs.netPayout.textContent = formatCurrency(payouts.netPayout);
            outputs.gst.textContent = formatCurrency(payouts.gstAmount);
            outputs.totalPayout.textContent = formatCurrency(payouts.totalPayout);
            outputs.incomeTax.textContent = formatNegativeCurrency(payouts.incomeTaxWithheld);
            outputs.gstWithheld.textContent = formatNegativeCurrency(payouts.gstWithheld);
            outputs.gstPayable.textContent = formatCurrency(payouts.gstPayable);
            outputs.finalCredited.textContent = formatCurrency(payouts.finalCredited);
            outputs.pureEarning.textContent = formatCurrency(payouts.pureEarning);
            outputs.tvaPerc.textContent = `${tvaPercentage.toFixed(0)}%`;
            outputs.labelGst.textContent = `GST (${(payouts.gstRate * 100).toFixed(0)}%)`;
            outputs.labelGstWithheld.textContent = `GST Withheld (${(payouts.gstWithheldRate * 100).toFixed(0)}%)`;
            outputs.mnpMsg.classList.toggle('hidden', tvaPercentage >= 100);
            outputs.tva.className = `font-semibold ${payouts.tvaPayout >= 0 ? 'text-green-400' : 'text-red-400'}`;
            outputs.qos.className = `font-semibold ${payouts.qosPayout >= 0 ? 'text-green-400' : 'text-red-400'}`;
            updateMnpStatus(achievedMnpAbs, currentMnpSlab, mnpTargets, tvaPercentage);
            absOutputs.totalActivations.textContent = achievedTva.toLocaleString();
            absOutputs.qosOverall.textContent = Math.round((qosOverallPerc / 100) * achievedTva).toLocaleString();
            absOutputs.qosSpecific.textContent = Math.round((qosSpecificPerc / 100) * achievedTva).toLocaleString();
            absOutputs.mnpAch.textContent = achievedMnpAbs.toLocaleString();
            outputs.absTargetMnpA.textContent = mnpTargets.A.toLocaleString();
            outputs.absTargetMnpB.textContent = mnpTargets.B.toLocaleString();
            outputs.absTargetMnpC.textContent = mnpTargets.C.toLocaleString();
        }

        function updateShoutout(pureEarning, activations, mnp, qos) {
            if (activations > 0) {
                 const perSimEarning = pureEarning / activations;
                 outputs.shoutoutSection.innerHTML = `Dear partner: You can earn a total of <strong>${formatCurrency(pureEarning)}</strong> by doing sales of <strong>${activations}</strong> Activations with <strong>${mnp}</strong> MNP and getting <strong>${qos}%</strong> QoS. This refers to a per SIM payout of <strong>${formatCurrency(perSimEarning)}</strong>.`;
            } else {
                 outputs.shoutoutSection.innerHTML = `Enter your targets and achievements to see your potential earnings.`;
            }
        }

        function updateMnpStatus(achieved, slab, targets, tvaPercentage) {
            let statusHtml = '';
            if (tvaPercentage < 100) {
                statusHtml = `You must achieve <strong>100% TVA</strong> to be eligible for any MNP payout.`;
            } else {
                if(slab === 'None') {
                    statusHtml = `You have not achieved any MNP slab. Achieve <strong>${targets.A}</strong> for Slab A.`;
                } else {
                    statusHtml = `You have achieved <strong>Slab ${slab}</strong>! `;
                    let nextSlab, nextTarget, nextPayoutRate, currentPayoutRate;
                    if (slab === 'A') { nextSlab = 'B'; nextTarget = targets.B; nextPayoutRate = 500; currentPayoutRate = 300; } 
                    else if (slab === 'B') { nextSlab = 'C'; nextTarget = targets.C; nextPayoutRate = 700; currentPayoutRate = 500; }
                    
                    if (nextSlab && nextTarget > 0 && achieved < nextTarget) {
                        const deficit = nextTarget - achieved;
                        const currentPayout = achieved * currentPayoutRate;
                        const nextPayout = nextTarget * nextPayoutRate;
                        const potentialExtra = nextPayout - currentPayout;
                        statusHtml += `Achieve <strong>${deficit}</strong> more for Slab ${nextSlab} to earn an extra <strong>${formatCurrency(potentialExtra)}</strong>.`;
                    } else if (slab === 'C') {
                        statusHtml += `Congratulations, you've reached the top MNP slab!`;
                    }
                }
            }
            outputs.mnpStatusFeedback.innerHTML = statusHtml;
        }

        // --- EVENT HANDLING & LOGIC ---
        function syncSliderAndInput(slider, numberInput, isQos) {
            const tooltip = slider.previousElementSibling;
            
            function updateTooltip() {
                const percent = (slider.value - slider.min) / (slider.max - slider.min);
                const thumbWidth = 20;
                const offset = (thumbWidth / 2) - (thumbWidth * percent);
                tooltip.style.left = `calc(${percent * 100}% - ${offset}px)`;
                tooltip.textContent = `${slider.value}%`;
                tooltip.style.display = 'block';
            }

            slider.addEventListener('input', (e) => {
                numberInput.value = e.target.value;
                if (isQos) enforceQosLogic(slider);
                updateTooltip();
                calculatePayout();
            });
            numberInput.addEventListener('input', (e) => {
                let value = parseInt(e.target.value);
                if (isNaN(value)) value = 0;
                if (value > parseInt(slider.max)) value = parseInt(slider.max);
                if (value < parseInt(slider.min)) value = parseInt(slider.min);
                e.target.value = value;
                slider.value = value;
                if (isQos) enforceQosLogic(numberInput);
                updateTooltip();
                calculatePayout();
            });
            slider.addEventListener('mouseenter', updateTooltip);
            slider.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });
        }
        
        function enforceQosLogic(sourceElement) {
            let overallSlider = inputs.achievedQosOverall, specificSlider = inputs.achievedQosSpecific;
            if (sourceElement.id.includes('overall')) {
                if (parseInt(overallSlider.value) < parseInt(specificSlider.value)) {
                    specificSlider.value = overallSlider.value;
                    inputs.achievedQosSpecificNum.value = overallSlider.value;
                }
            } else {
                if (parseInt(specificSlider.value) > parseInt(overallSlider.value)) {
                    overallSlider.value = specificSlider.value;
                    inputs.achievedQosOverallNum.value = specificSlider.value;
                }
            }
        }
        
        // --- WHAT-IF ANALYSIS ---
        function whatIfCalculation(tvaPerc, qosPerc, mnpPayoutValue) {
            const targetMain = parseInt(inputs.targetMain.value) || 0;
            const province = inputs.province.value;
            const achievedTva = Math.round((tvaPerc / 100) * targetMain);
            let mtsRentPayout = achievedTva * 450, perSimPayout = achievedTva * 700;
            let tvaPayout = 0;
            const currentTvaTier = tvaTiers.find(t => tvaPerc >= t.threshold);
            if (currentTvaTier) {
                if (currentTvaTier.value >= 0) tvaPayout = currentTvaTier.value * achievedTva;
                else { const deficit = targetMain - achievedTva; tvaPayout = deficit > 0 ? deficit * currentTvaTier.value : 0; }
            }
            let qosPayout = 0;
            const currentQosTier = qosTiers.find(t => qosPerc >= t.threshold);
            if(currentQosTier) {
                if (currentQosTier.value >= 0) qosPayout = (qosPerc / 100) * currentQosTier.value * achievedTva;
                else { const qualityDeficit = targetMain - ((qosPerc / 100) * achievedTva); qosPayout = qualityDeficit > 0 ? currentQosTier.value * qualityDeficit : 0; }
            }
            const netPayout = mtsRentPayout + perSimPayout + tvaPayout + qosPayout + mnpPayoutValue;
            let gstRate = 0;
            if (province === 'punjab') gstRate = 0.16;
            else if (province) gstRate = 0.15;
            const totalPayout = netPayout + (netPayout * gstRate);
            const incomeTaxWithheld = totalPayout * 0.12;
            return netPayout - incomeTaxWithheld;
        }

        function generateWhatIfTable(containerId, data, tvaRange, qosLevels) {
            const container = document.getElementById(containerId);
            if (!container || !data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500">Enter a main target to see analysis.</p>';
                return;
            }

            let tableHTML = '<div class="overflow-x-auto relative mt-4"><table class="w-full text-sm text-left text-slate-500">';
            tableHTML += '<thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0"><tr><th scope="col" class="px-2 py-3 bg-slate-200 z-10">TVA \\ QoS</th>';
            qosLevels.forEach(qos => { tableHTML += `<th scope="col" class="px-2 py-3 text-center">${qos}%</th>`; });
            tableHTML += '</tr></thead><tbody>';
            tvaRange.forEach((tva, rowIndex) => {
                tableHTML += `<tr class="bg-white border-b"><th scope="row" class="px-2 py-2 font-medium text-slate-900 whitespace-nowrap bg-slate-100 sticky left-0">${tva}%</th>`;
                qosLevels.forEach((_, colIndex) => {
                    const value = data[colIndex].y[rowIndex];
                    tableHTML += `<td class="px-2 py-2 text-right">${formatCurrency(value)}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        }

        function runWhatIfAnalysis() {
            const tvaRange = [115, 110, 100, 90, 75, 50];
            const qosLevels = [30, 40, 45, 50, 55, 60];
            const targetMain = parseInt(inputs.targetMain.value) || 0;
            if (targetMain === 0 || !inputs.province.value) {
                // Clear tables if no target
                generateWhatIfTable('whatif-table-a', [], [], []);
                generateWhatIfTable('whatif-table-b', [], [], []);
                generateWhatIfTable('whatif-table-c', [], [], []);
                return;
            }

            const mnpTargets = {
                A: Math.round((parseInt(inputs.targetMnpAPerc.value) / 100) * targetMain),
                B: Math.round((parseInt(inputs.targetMnpBPerc.value) / 100) * targetMain),
                C: Math.round((parseInt(inputs.targetMnpCPerc.value) / 100) * targetMain)
            };
            const mnpPayouts = { A: mnpTargets.A * 300, B: mnpTargets.B * 500, C: mnpTargets.C * 700 };

            const tableDataA = qosLevels.map(qos => ({ y: tvaRange.map(tva => whatIfCalculation(tva, qos, tva >= 100 ? mnpPayouts.A : 0)) }));
            const tableDataB = qosLevels.map(qos => ({ y: tvaRange.map(tva => whatIfCalculation(tva, qos, tva >= 100 ? mnpPayouts.B : 0)) }));
            const tableDataC = qosLevels.map(qos => ({ y: tvaRange.map(tva => whatIfCalculation(tva, qos, tva >= 100 ? mnpPayouts.C : 0)) }));

            generateWhatIfTable('whatif-table-a', tableDataA, tvaRange, qosLevels);
            generateWhatIfTable('whatif-table-b', tableDataB, tvaRange, qosLevels);
            generateWhatIfTable('whatif-table-c', tableDataC, tvaRange, qosLevels);
        }

        // --- INITIALIZATION ---
        inputs.province.addEventListener('change', () => {
            provinceGate.classList.add('hidden');
            mainContent.classList.remove('content-locked');
            calculatePayout();
            runWhatIfAnalysis();
        });

        syncSliderAndInput(inputs.achievedTvaPerc, inputs.achievedTvaPercNum, false);
        syncSliderAndInput(inputs.achievedQosOverall, inputs.achievedQosOverallNum, true);
        syncSliderAndInput(inputs.achievedQosSpecific, inputs.achievedQosSpecificNum, true);
        
        Object.values(inputs).forEach(input => {
             if (input.id !== 'province') {
                input.addEventListener('input', () => {
                    calculatePayout();
                    runWhatIfAnalysis();
                });
             }
        });

        // Initial call to set defaults correctly
        calculatePayout();
    });
    </script>
</body>
</html>
