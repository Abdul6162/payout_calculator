<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Partner Payout Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chosen Palette: ONIC Brand Colors -->
    <!-- Application Structure Plan: The application is designed as a task-oriented dashboard. The primary user task is to calculate potential earnings. The layout is a two-part grid: Inputs on the left, and Outputs on the right. This allows users to immediately see the result of their changes. Below this main tool, supplementary charts provide visual context for the commission tiers. This structure prioritizes the user's primary goal (calculation) while still offering the necessary explanatory details, making it highly efficient and user-friendly. -->
    <!-- Visualization & Content Choices: TVA & QoS Tiers: Goal is to compare. Bar charts (Chart.js/Canvas) are used to visually distinguish bonus vs. deduction tiers. The active tier is highlighted based on slider input, creating a direct visual link between action and consequence. Payout Logic: Goal is to organize and engage. An interactive calculator (HTML/JS) is the core of the app. It translates complex business rules into a simple, hands-on tool. MNP Payout: Goal is to inform. The output is dynamically shown or hidden based on the 100% target condition, clearly communicating this critical rule. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            --onic-purple: #5F259F;
            --onic-dark: #1E1E1E;
            --onic-accent-pink: #E5007E;
            --onic-light-gray: #f8f9fa;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--onic-light-gray); }
        .chart-container { position: relative; width: 100%; max-width: 700px; margin-left: auto; margin-right: auto; height: 350px; max-height: 400px; }
        @media (min-width: 768px) { .chart-container { height: 400px; } }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--onic-purple); cursor: pointer; border-radius: 50%; margin-top: -8px;}
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: var(--onic-purple); cursor: pointer; border-radius: 50%; }
        .input-group { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .input-sync-group { display: flex; align-items: center; gap: 1rem; }
        .input-sync-group input[type=range] { flex-grow: 1; }
        .input-sync-group input[type=number] { width: 5rem; text-align: right; }
    </style>
</head>
<body class="bg-slate-100">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold" style="color: var(--onic-dark);">Partner Payout Calculator</h1>
            <p class="mt-2 text-lg text-slate-600">Estimate your earnings based on your performance.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Targets Input Group -->
                <div class="input-group">
                    <h2 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2">Your Targets</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                        <div>
                            <label for="target-main" class="block text-sm font-medium text-slate-700">Overall Activation Target</label>
                            <input type="number" id="target-main" value="200" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                        </div>
                        <div></div>
                        <div>
                            <label for="target-mnp-a-perc" class="block text-sm font-medium text-slate-700">MNP Target (A) % of Overall</label>
                            <input type="number" id="target-mnp-a-perc" value="10" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                        </div>
                        <div class="bg-slate-50 p-2 rounded-lg text-center">
                            <p class="text-sm text-slate-500">Abs. Target (A)</p>
                            <p id="abs-target-mnp-a" class="font-bold text-slate-800">0</p>
                        </div>
                        <div>
                            <label for="target-mnp-b-perc" class="block text-sm font-medium text-slate-700">MNP Target (B) % of Overall</label>
                            <input type="number" id="target-mnp-b-perc" value="5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                        </div>
                         <div class="bg-slate-50 p-2 rounded-lg text-center">
                            <p class="text-sm text-slate-500">Abs. Target (B)</p>
                            <p id="abs-target-mnp-b" class="font-bold text-slate-800">0</p>
                        </div>
                        <div>
                            <label for="target-mnp-c-perc" class="block text-sm font-medium text-slate-700">MNP Target (C) % of Overall</label>
                            <input type="number" id="target-mnp-c-perc" value="5" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                        </div>
                         <div class="bg-slate-50 p-2 rounded-lg text-center">
                            <p class="text-sm text-slate-500">Abs. Target (C)</p>
                            <p id="abs-target-mnp-c" class="font-bold text-slate-800">0</p>
                        </div>
                    </div>
                </div>

                <!-- Achievements Input Group -->
                <div class="input-group">
                    <h2 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2">Your Achievements</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="province" class="block text-sm font-medium text-slate-700">Province (for Tax Calculation)</label>
                            <select id="province" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                                <option value="punjab">Punjab</option>
                                <option value="kpk">KPK</option>
                                <option value="sindh">Sindh</option>
                                <option value="balochistan">Balochistan</option>
                            </select>
                        </div>
                        <div>
                            <label for="achieved-tva-perc" class="block text-sm font-medium text-slate-700 mb-1">TVA Achievement %</label>
                            <div class="input-sync-group">
                                <input type="range" id="achieved-tva-perc" min="0" max="200" value="75" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="achieved-tva-perc-num" min="0" max="200" value="75" class="p-2 rounded-md border-slate-300 shadow-sm">
                            </div>
                        </div>
                        <div>
                            <label for="achieved-qos-overall" class="block text-sm font-medium text-slate-700 mb-1">Overall QoS %</label>
                            <div class="input-sync-group">
                                <input type="range" id="achieved-qos-overall" min="0" max="100" value="45" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="achieved-qos-overall-num" min="0" max="100" value="45" class="p-2 rounded-md border-slate-300 shadow-sm">
                            </div>
                        </div>
                        <div>
                             <label for="achieved-qos-specific" class="block text-sm font-medium text-slate-700 mb-1">QoS % (w/o other plans)</label>
                            <div class="input-sync-group">
                                <input type="range" id="achieved-qos-specific" min="0" max="100" value="35" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                                <input type="number" id="achieved-qos-specific-num" min="0" max="100" value="35" class="p-2 rounded-md border-slate-300 shadow-sm">
                            </div>
                        </div>
                        <div class="pt-4 border-t">
                             <label for="achieved-mnp-abs" class="block text-sm font-medium text-slate-700">MNP Achieved (without Ufone)</label>
                             <input type="number" id="achieved-mnp-abs" value="15" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                             <div id="mnp-status-feedback" class="mt-2 text-sm text-center p-3 rounded-lg" style="background-color: #f3e9fd;"></div>
                        </div>
                    </div>
                </div>
                 <!-- Absolute Numbers Display -->
                <div class="input-group">
                    <h2 class="text-xl font-bold text-slate-700 mb-4 border-b pb-2">Calculated Absolute Numbers</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-sm text-slate-500">Activations</p>
                            <p id="abs-total-activations" class="text-2xl font-bold text-slate-800">0</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-sm text-slate-500">Overall QoS</p>
                            <p id="abs-qos-overall" class="text-2xl font-bold text-slate-800">0</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-sm text-slate-500">Specific QoS</p>
                            <p id="abs-qos-specific" class="text-2xl font-bold text-slate-800">0</p>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg">
                            <p class="text-sm text-slate-500">MNP Achieved</p>
                            <p id="abs-mnp-ach" class="text-2xl font-bold text-slate-800">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Outputs -->
            <div class="lg:col-span-2">
                <div class="text-white rounded-xl shadow-lg p-6 sticky top-8" style="background-color: var(--onic-dark);">
                    <h2 class="text-xl font-bold mb-4 border-b border-slate-600 pb-2">Payout & Tax Breakdown</h2>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-300">MTS-S Rent</span>
                            <span id="output-mts-rent" class="font-semibold">PKR 0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-300">Per SIM Payout</span>
                            <span id="output-per-sim" class="font-semibold">PKR 0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-300">TVA Payout (<span id="output-tva-perc" class="text-xs">0%</span>)</span>
                            <span id="output-tva" class="font-semibold">PKR 0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-300">QoS Payout</span>
                            <span id="output-qos" class="font-semibold">PKR 0</span>
                        </div>
                        <div class="flex justify-between items-center pb-2">
                            <span class="text-slate-300">MNP Payout (Top Slab)</span>
                            <span id="output-mnp" class="font-semibold">PKR 0</span>
                        </div>
                        <p id="mnp-condition-msg" class="text-xs text-amber-400 text-center hidden">MNP payout requires 100% of overall target.</p>
                        
                        <div class="border-t border-slate-600 !mt-3 pt-3 space-y-2">
                             <div class="flex justify-between items-center font-bold text-base">
                                <span class="text-slate-200">Net Payout</span>
                                <span id="output-net-payout" class="text-slate-100">PKR 0</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span id="label-gst" class="text-slate-300">GST</span>
                                <span id="output-gst" class="font-semibold">PKR 0</span>
                            </div>
                             <div class="flex justify-between items-center font-bold text-base pb-2">
                                <span class="text-slate-200">Total Payout</span>
                                <span id="output-total-payout" class="text-slate-100">PKR 0</span>
                            </div>
                        </div>

                         <div class="border-t border-slate-600 !mt-3 pt-3 space-y-2">
                             <div class="flex justify-between items-center">
                                <span class="text-slate-300">Income Tax Withheld (12%)</span>
                                <span id="output-income-tax" class="font-semibold text-red-400">(PKR 0)</span>
                            </div>
                             <div class="flex justify-between items-center">
                                <span id="label-gst-withheld" class="text-slate-300">GST Withheld</span>
                                <span id="output-gst-withheld" class="font-semibold text-red-400">(PKR 0)</span>
                            </div>
                         </div>
                        
                        <div class="border-t border-slate-600 !mt-3 pt-3 space-y-3">
                            <div class="flex justify-between items-center text-xl">
                                <span class="font-bold">Amount Credited</span>
                                <span id="output-final-credited" class="font-extrabold" style="color: var(--onic-accent-pink);">PKR 0</span>
                            </div>
                             <div class="flex justify-between items-center text-base">
                                <span class="text-slate-300">Pure Partner Earning</span>
                                <span id="output-pure-earning" class="font-semibold text-sky-400">PKR 0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Visualizations Section -->
        <section class="mt-12">
             <h2 class="text-2xl font-bold text-center mb-1" style="color: var(--onic-dark);">Commission Tier Visualizer</h2>
             <p class="text-slate-500 text-center mb-8">Your achievement level determines the payout slab. See how it works below.</p>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-lg p-6">
                     <h3 class="text-lg font-semibold text-slate-700 mb-4 text-center">TVA Payout Slabs</h3>
                    <div class="chart-container">
                        <canvas id="tvaChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4 text-center">QoS Payout Slabs</h3>
                    <div class="chart-container">
                        <canvas id="qosChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        const tvaTiers = [
            { threshold: 115, value: 400, label: '115%+' }, { threshold: 110, value: 300, label: '110-115%' },
            { threshold: 100, value: 200, label: '100-110%' }, { threshold: 90, value: 0, label: '90-100%' },
            { threshold: 75, value: -100, label: '75-90%' }, { threshold: 50, value: -200, label: '50-75%' },
            { threshold: 0, value: -300, label: '< 50%' }
        ];
        const qosTiers = [
            { threshold: 55, value: 600, label: '55%+' }, { threshold: 45, value: 400, label: '45-55%' },
            { threshold: 40, value: 200, label: '40-45%' }, { threshold: 30, value: -200, label: '30-40%' },
            { threshold: 0, value: -300, label: '< 30%' }
        ];

        const inputs = {
            targetMain: document.getElementById('target-main'),
            targetMnpAPerc: document.getElementById('target-mnp-a-perc'),
            targetMnpBPerc: document.getElementById('target-mnp-b-perc'),
            targetMnpCPerc: document.getElementById('target-mnp-c-perc'),
            province: document.getElementById('province'),
            achievedTvaPerc: document.getElementById('achieved-tva-perc'),
            achievedTvaPercNum: document.getElementById('achieved-tva-perc-num'),
            achievedQosOverall: document.getElementById('achieved-qos-overall'),
            achievedQosOverallNum: document.getElementById('achieved-qos-overall-num'),
            achievedQosSpecific: document.getElementById('achieved-qos-specific'),
            achievedQosSpecificNum: document.getElementById('achieved-qos-specific-num'),
            achievedMnpAbs: document.getElementById('achieved-mnp-abs'),
        };

        const outputs = {
            mtsRent: document.getElementById('output-mts-rent'),
            perSim: document.getElementById('output-per-sim'),
            tva: document.getElementById('output-tva'),
            tvaPerc: document.getElementById('output-tva-perc'),
            qos: document.getElementById('output-qos'),
            mnp: document.getElementById('output-mnp'),
            netPayout: document.getElementById('output-net-payout'),
            gst: document.getElementById('output-gst'),
            totalPayout: document.getElementById('output-total-payout'),
            incomeTax: document.getElementById('output-income-tax'),
            gstWithheld: document.getElementById('output-gst-withheld'),
            finalCredited: document.getElementById('output-final-credited'),
            pureEarning: document.getElementById('output-pure-earning'),
            mnpMsg: document.getElementById('mnp-condition-msg'),
            mnpStatusFeedback: document.getElementById('mnp-status-feedback'),
            absTargetMnpA: document.getElementById('abs-target-mnp-a'),
            absTargetMnpB: document.getElementById('abs-target-mnp-b'),
            absTargetMnpC: document.getElementById('abs-target-mnp-c'),
            labelGst: document.getElementById('label-gst'),
            labelGstWithheld: document.getElementById('label-gst-withheld'),
        };
        
        const absOutputs = {
            totalActivations: document.getElementById('abs-total-activations'),
            qosOverall: document.getElementById('abs-qos-overall'),
            qosSpecific: document.getElementById('abs-qos-specific'),
            mnpAch: document.getElementById('abs-mnp-ach'),
        };

        const formatCurrency = (value) => `PKR ${Math.round(value).toLocaleString()}`;
        const formatNegativeCurrency = (value) => `(PKR ${Math.round(value).toLocaleString()})`;

        function calculatePayout() {
            const targetMain = parseInt(inputs.targetMain.value) || 0;
            const targetMnpAPerc = parseInt(inputs.targetMnpAPerc.value) || 0;
            const targetMnpBPerc = parseInt(inputs.targetMnpBPerc.value) || 0;
            const targetMnpCPerc = parseInt(inputs.targetMnpCPerc.value) || 0;
            const province = inputs.province.value;

            const tvaPercentage = parseInt(inputs.achievedTvaPerc.value);
            const qosOverallPerc = parseInt(inputs.achievedQosOverall.value);
            const qosSpecificPerc = parseInt(inputs.achievedQosSpecific.value);
            const achievedMnpAbs = parseInt(inputs.achievedMnpAbs.value) || 0;
            
            const achievedTva = Math.round((tvaPercentage / 100) * targetMain);

            outputs.tvaPerc.textContent = `${tvaPercentage.toFixed(1)}%`;

            let mtsRentPayout = achievedTva * 450;
            let perSimPayout = achievedTva * 700;
            
            let tvaPayout = 0;
            const currentTvaTier = tvaTiers.find(t => tvaPercentage >= t.threshold);
            if (currentTvaTier) {
                if (currentTvaTier.value >= 0) {
                    tvaPayout = currentTvaTier.value * achievedTva;
                } else {
                    const deficit = targetMain - achievedTva;
                    tvaPayout = deficit > 0 ? deficit * currentTvaTier.value : 0;
                }
            }
            
            let qosPayout = 0;
            const currentQosTier = qosTiers.find(t => qosOverallPerc >= t.threshold);
            if(currentQosTier) {
                if (currentQosTier.value >= 0) {
                    qosPayout = (qosSpecificPerc / 100) * currentQosTier.value * achievedTva;
                } else {
                    const qualityDeficit = targetMain - ((qosOverallPerc / 100) * achievedTva);
                    qosPayout = qualityDeficit > 0 ? currentQosTier.value * qualityDeficit : 0;
                }
            }
            
            const targetMnpANum = Math.round((targetMnpAPerc / 100) * targetMain);
            const targetMnpBNum = Math.round((targetMnpBPerc / 100) * targetMain);
            const targetMnpCNum = Math.round((targetMnpCPerc / 100) * targetMain);
            
            outputs.absTargetMnpA.textContent = targetMnpANum.toLocaleString();
            outputs.absTargetMnpB.textContent = targetMnpBNum.toLocaleString();
            outputs.absTargetMnpC.textContent = targetMnpCNum.toLocaleString();

            let mnpPayout = 0;
            let currentMnpSlab = 'None';
            if (tvaPercentage >= 100) {
                if (achievedMnpAbs >= targetMnpCNum && targetMnpCNum > 0) {
                    mnpPayout = achievedMnpAbs * 700;
                    currentMnpSlab = 'C';
                } else if (achievedMnpAbs >= targetMnpBNum && targetMnpBNum > 0) {
                    mnpPayout = achievedMnpAbs * 500;
                    currentMnpSlab = 'B';
                } else if (achievedMnpAbs >= targetMnpANum && targetMnpANum > 0) {
                    mnpPayout = achievedMnpAbs * 300;
                    currentMnpSlab = 'A';
                }
                outputs.mnpMsg.classList.add('hidden');
            } else {
                outputs.mnpMsg.classList.remove('hidden');
            }
            
            updateMnpStatus(achievedMnpAbs, currentMnpSlab, {A: targetMnpANum, B: targetMnpBNum, C: targetMnpCNum}, tvaPercentage);

            const netPayout = mtsRentPayout + perSimPayout + tvaPayout + qosPayout + mnpPayout;

            // Tax Calculations
            let gstRate = 0.15;
            let gstWithheldRate = 0.20;
            if (province === 'punjab') {
                gstRate = 0.16;
                gstWithheldRate = 1.0;
            } else if (province === 'kpk') {
                gstWithheldRate = 0.50;
            }

            const gstAmount = netPayout * gstRate;
            const totalPayout = netPayout + gstAmount;
            const incomeTaxWithheld = totalPayout * 0.12;
            const gstWithheld = gstAmount * gstWithheldRate;
            const amountCredited = totalPayout - incomeTaxWithheld - gstWithheld;
            const pureEarning = netPayout - incomeTaxWithheld;

            // Update UI
            outputs.mtsRent.textContent = formatCurrency(mtsRentPayout);
            outputs.perSim.textContent = formatCurrency(perSimPayout);
            outputs.tva.textContent = formatCurrency(tvaPayout);
            outputs.qos.textContent = formatCurrency(qosPayout);
            outputs.mnp.textContent = formatCurrency(mnpPayout);
            outputs.netPayout.textContent = formatCurrency(netPayout);
            
            outputs.labelGst.textContent = `GST (${(gstRate * 100).toFixed(0)}%)`;
            outputs.gst.textContent = formatCurrency(gstAmount);
            outputs.totalPayout.textContent = formatCurrency(totalPayout);
            outputs.incomeTax.textContent = formatNegativeCurrency(incomeTaxWithheld);
            outputs.labelGstWithheld.textContent = `GST Withheld (${(gstWithheldRate * 100).toFixed(0)}%)`;
            outputs.gstWithheld.textContent = formatNegativeCurrency(gstWithheld);
            outputs.finalCredited.textContent = formatCurrency(amountCredited);
            outputs.pureEarning.textContent = formatCurrency(pureEarning);
            
            outputs.tva.className = `font-semibold ${tvaPayout >= 0 ? 'text-green-400' : 'text-red-400'}`;
            outputs.qos.className = `font-semibold ${qosPayout >= 0 ? 'text-green-400' : 'text-red-400'}`;
            
            absOutputs.totalActivations.textContent = achievedTva.toLocaleString();
            absOutputs.qosOverall.textContent = Math.round((qosOverallPerc / 100) * achievedTva).toLocaleString();
            absOutputs.qosSpecific.textContent = Math.round((qosSpecificPerc / 100) * achievedTva).toLocaleString();
            absOutputs.mnpAch.textContent = achievedMnpAbs.toLocaleString();

            updateChartHighlight(tvaChart, tvaTiers.indexOf(currentTvaTier));
            updateChartHighlight(qosChart, qosTiers.indexOf(currentQosTier));
        }

        function updateMnpStatus(achieved, slab, targets, tvaPercentage) {
            let statusHtml = '';
            if (tvaPercentage < 100) {
                statusHtml = `You must achieve <strong>100% TVA</strong> to be eligible for any MNP payout.`;
            } else {
                if(slab === 'None') {
                    statusHtml = `You have not achieved any MNP slab. Achieve <strong>${targets.A}</strong> for Slab A.`;
                } else {
                    statusHtml = `You have achieved <strong>Slab ${slab}</strong>! `;
                    let nextSlab, nextTarget, nextPayoutRate, currentPayoutRate;
                    if (slab === 'A') {
                        nextSlab = 'B';
                        nextTarget = targets.B;
                        nextPayoutRate = 500;
                        currentPayoutRate = 300;
                    } else if (slab === 'B') {
                        nextSlab = 'C';
                        nextTarget = targets.C;
                        nextPayoutRate = 700;
                        currentPayoutRate = 500;
                    }
                    
                    if (nextSlab && nextTarget > 0 && achieved < nextTarget) {
                        const deficit = nextTarget - achieved;
                        const potentialExtra = (nextTarget * nextPayoutRate) - (achieved * currentPayoutRate);
                        statusHtml += `Achieve <strong>${deficit}</strong> more for Slab ${nextSlab} to earn an extra <strong>${formatCurrency(potentialExtra)}</strong>.`;
                    } else if (slab === 'C') {
                        statusHtml += `Congratulations, you've reached the top MNP slab!`;
                    }
                }
            }
            outputs.mnpStatusFeedback.innerHTML = statusHtml;
        }

        function syncSliderAndInput(slider, numberInput, isQos) {
            slider.addEventListener('input', (e) => {
                numberInput.value = e.target.value;
                if (isQos) enforceQosLogic(slider);
                calculatePayout();
            });
            numberInput.addEventListener('input', (e) => {
                let value = parseInt(e.target.value);
                if (isNaN(value)) value = 0;
                if (value > parseInt(slider.max)) value = parseInt(slider.max);
                if (value < parseInt(slider.min)) value = parseInt(slider.min);
                e.target.value = value;
                slider.value = value;
                if (isQos) enforceQosLogic(numberInput);
                calculatePayout();
            });
        }
        
        function enforceQosLogic(sourceElement) {
            let overallSlider = inputs.achievedQosOverall;
            let overallNum = inputs.achievedQosOverallNum;
            let specificSlider = inputs.achievedQosSpecific;
            let specificNum = inputs.achievedQosSpecificNum;
            
            if (sourceElement.id.includes('overall')) {
                if (parseInt(overallSlider.value) < parseInt(specificSlider.value)) {
                    specificSlider.value = overallSlider.value;
                    specificNum.value = overallSlider.value;
                }
            } else { // Source is specific
                if (parseInt(specificSlider.value) > parseInt(overallSlider.value)) {
                    overallSlider.value = specificSlider.value;
                    overallNum.value = specificSlider.value;
                }
            }
        }

        syncSliderAndInput(inputs.achievedTvaPerc, inputs.achievedTvaPercNum, false);
        syncSliderAndInput(inputs.achievedQosOverall, inputs.achievedQosOverallNum, true);
        syncSliderAndInput(inputs.achievedQosSpecific, inputs.achievedQosSpecificNum, true);

        function updateChartHighlight(chart, activeIndex) {
            chart.data.datasets.forEach(dataset => {
                dataset.borderWidth = dataset.data.map((_, i) => i === activeIndex ? 3 : 1);
                dataset.borderColor = dataset.data.map((_, i) => i === activeIndex ? 'var(--onic-purple)' : (dataset.data[i] >= 0 ? '#16a34a' : '#dc2626'));
            });
            chart.update();
        }
        
        Object.values(inputs).forEach(input => {
            if (!input.id.includes('perc-num') && !input.id.includes('range')) {
                 input.addEventListener('input', calculatePayout);
            }
        });

        const chartOptions = {
            maintainAspectRatio: false, responsive: true,
            scales: { y: { beginAtZero: true, ticks: { callback: value => `PKR ${value}` } }, x: { grid: { display: false } } },
            plugins: { legend: { display: false }, tooltip: { callbacks: { label: (c) => `Slab: ${formatCurrency(c.parsed.y)}` } } }
        };

        const tvaChart = new Chart(document.getElementById('tvaChart').getContext('2d'), {
            type: 'bar',
            data: { labels: tvaTiers.map(t => t.label), datasets: [{ data: tvaTiers.map(t => t.value), backgroundColor: tvaTiers.map(t => t.value >= 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)'), borderWidth: 1, borderRadius: 4 }] },
            options: chartOptions
        });

        const qosChart = new Chart(document.getElementById('qosChart').getContext('2d'), {
            type: 'bar',
            data: { labels: qosTiers.map(t => t.label), datasets: [{ data: qosTiers.map(t => t.value), backgroundColor: qosTiers.map(t => t.value >= 0 ? 'rgba(34, 197, 94, 0.6)' : 'rgba(239, 68, 68, 0.6)'), borderWidth: 1, borderRadius: 4 }] },
            options: chartOptions
        });

        window.addEventListener('load', calculatePayout);
    </script>
</body>
</html>
